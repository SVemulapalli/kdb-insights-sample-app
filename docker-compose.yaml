version: "3.0"
#
# Optional: Create volumes to include licence/configuration in the containers.
#
x-vols: &vols
  volumes:
  - ${kx_licence_dir}:/opt/kx/lic
  - ./cfg:/opt/kx/cfg
  - ${mnt_dir}:${mnt_dir}
#  - ${custom_dir}:/opt/kx/custom # Optional mount for loading custom code

#
# Optional: Create a network for processes to communicate.
#
x-kxnet: &kxnet
  networks:
  - kx

networks:
  kx:
    name: kx
    driver: bridge

#
# Services.
#
services:
  #
  # Resource Coordinator -- 1 per assembly.
  #
  sgrc:
    image: ${registry}/kxi-sg-rc:${sg_version}
    environment:
      - KXI_NAME=sg_rc
      - KXI_PORT=5060
      - KXI_LOG_FORMAT=text # Optional
      - KXI_LOG_LEVELS=default:debug # Optional
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
    ports:
      - 127.0.0.1::5060
    <<: *vols # Optional
    <<: *kxnet # Optional


  #
  # Aggregator. Note we only have one here, but multiple can be configured.
  #
  sgagg:
    image: ${registry}/kxi-sg-agg:${sg_version}
    environment:
      - KXI_NAME=sg_agg
      - KXI_PORT=5050
      - KXI_LOG_FORMAT=text # Optional
      - KXI_LOG_LEVELS=default:debug # Optional
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - KXI_SG_RC_ADDR=sgrc:5060
    ports:
      - 127.0.0.1::5050
    # Optional: deploy multiple replicas.
    deploy:
      mode: replicated
      replicas: 3
    <<: *vols # Optional
    <<: *kxnet # Optional

  #
  # Gateway.
  #
  sggw:
    image: ${registry}/kxi-sg-gw:${sg_version}
    environment:
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - GATEWAY_QIPC_PORT=5040
      - GATEWAY_HTTP_PORT=8080
    ports:
      - 127.0.0.1::5040
      - 127.0.0.1::8080
    # Optional: deploy multiple replicas.
    deploy:
      mode: replicated
      replicas: 3
    <<: *vols # Optional
    <<: *kxnet # Optional

  sm:
  #
  # Storage Manager.
  #
    image: ${registry}/kxi-sm:${sm_version}
    environment:
      - KXI_NAME=sm
      - KXI_SC=SM
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - KXI_RT_LIB=/opt/kx/cfg/rt_tick_client_lib.q
      - KXI_PORT=10001
      - KXI_LOG_FORMAT=text
    ports:
      - 10001:10001
    stdin_open: true
    tty: true
    <<: *vols # Optional
    <<: *kxnet # Optional
  
  eoi:
  #
  # End of Interval
  #
    image: ${registry}/kxi-sm-eoi:${sm_version}
    environment:
      - KXI_NAME=eoi
      - KXI_SC=EOI
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - KXI_RT_LIB=/opt/kx/cfg/rt_tick_client_lib.q
      - KXI_PORT=10002
      - KXI_LOG_FORMAT=text
      - KXI_SM_SMADDR=sm:10001
    ports:
      - 10002:10002
    stdin_open: true
    tty: true
    <<: *vols # Optional
    <<: *kxnet # Optional
  
  eod:
  #
  # End of Day
  #
    image: ${registry}/kxi-sm-eod:${sm_version}
    environment:
      - KXI_NAME=eod
      - KXI_SC=EOD
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - KXI_RT_LIB=/opt/kx/cfg/rt_tick_client_lib.q
      - KXI_PORT=10003
      - KXI_LOG_FORMAT=text
      - KXI_SM_SMADDR=sm:10001
      - KXI_SM_EOIADDR=eoi:10002
    ports:
      - 10003:10003
    stdin_open: true
    tty: true
    <<: *vols # Optional
    <<: *kxnet # Optional

  dbm:
  #
  # DBM
  #
    image: ${registry}/kxi-sm-dbm:${sm_version}
    environment:
      - KXI_NAME=dbm
      - KXI_SC=DBM
      - KXI_ASSEMBLY_FILE=/opt/kx/cfg/${assembly_file_yaml}
      - KXI_RT_LIB=/opt/kx/cfg/rt_tick_client_lib.q
      - KXI_PORT=10004
      - KXI_LOG_FORMAT=text
      - KXI_SM_SMADDR=sm:10001
    ports:
      - 10004:10004
    stdin_open: true
    tty: true
    <<: *vols # Optional
    <<: *kxnet # Optional